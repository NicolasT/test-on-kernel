---
name: Test
on:
  - push
  - pull_request

jobs:
  test:
    name: Test
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          path: source
      - name: Cache
        uses: actions/cache@v3
        with:
          path: linux
          key: ${{ runner.os }}-linux-5.19.8
      - name: Download and build kernel
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends curl libelf-dev
          mkdir linux linux/source linux/build
          cp source/kernelconfig linux/build/.config
          cd linux/source
          if ! test -f Makefile; then
              curl -L https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.19.8.tar.xz | tar x --xz --strip-components=1
          fi
          make -j4 O=../build ARCH=x86_64 bzImage
      - name: Run testcase
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends pax-utils qemu-system-x86-64 dracut-core
          cabal update
          cd source
          cabal build test-on-kernel
          ln -s ../linux/build/arch/x86/boot/bzImage
          export PATH=$PATH:../linux/build/usr
          make initramfs
          make run
